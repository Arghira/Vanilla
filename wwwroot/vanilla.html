<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vanilla Unicorn – Rezervări</title>
    <style>
        :root {
            --bg: #0f1115;
            --panel: #131722;
            --panel-2: #1b2030;
            --text: #e6eaf2;
            --muted: #9aa4b2;
            --accent: #8ef0cf;
            --accent-2: #50c8ff;
            --danger: #ff6b6b;
            --gold: #d4af37;
            --ring: rgba(142,240,207,.25);
            --shadow: 0 18px 60px rgba(0,0,0,.35)
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            color: var(--text);
            background: #0b0e15;
            font: 14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
            overflow-x: hidden;
        }

            /* AURORA animated background */
            body::before, body::after {
                content: "";
                position: fixed;
                inset: -30% -10% auto -10%;
                height: 70%;
                filter: blur(60px);
                opacity: .35;
                z-index: -2;
                border-radius: 50%;
                background: radial-gradient(40% 60% at 20% 50%, #6ee7ff 0%, transparent 70%), radial-gradient(40% 60% at 80% 30%, #a78bfa 0%, transparent 70%), radial-gradient(30% 50% at 60% 90%, #22d3ee 0%, transparent 80%);
                animation: float1 20s ease-in-out infinite alternate;
            }

            body::after {
                inset: auto -5% -35% -5%;
                height: 60%;
                background: radial-gradient(40% 60% at 30% 20%, #f0abfc 0%, transparent 70%), radial-gradient(40% 60% at 70% 80%, #34d399 0%, transparent 75%);
                animation: float2 24s ease-in-out infinite alternate;
            }

        @keyframes float1 {
            to {
                transform: translateY(40px) translateX(20px) rotate(2deg)
            }
        }

        @keyframes float2 {
            to {
                transform: translateY(-30px) translateX(-10px) rotate(-2deg)
            }
        }

        /* HEADER minimalist */
        header.hero {
            position: sticky;
            top: 0;
            z-index: 40;
            padding: 20px 22px;
            border-bottom: 1px solid rgba(255,255,255,.06);
            backdrop-filter: saturate(140%) blur(6px);
            background: linear-gradient(180deg,rgba(8,10,16,.55),rgba(8,10,16,.25),rgba(8,10,16,0));
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .hero-title {
            margin: 0;
            font-weight: 900;
            line-height: 1.1;
            letter-spacing: .5px;
            font-size: clamp(24px,3.2vw,38px);
            background: linear-gradient(135deg,#d4af37 0%,#ffb6ff 60%,#ffffff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .toolbar {
            display: flex;
            gap: 10px
        }

        .btn {
            appearance: none;
            cursor: pointer;
            border-radius: 12px;
            padding: 10px 14px;
            border: 1px solid rgba(255,255,255,.12);
            background: var(--panel-2);
            color: var(--text);
            transition: transform .06s ease, box-shadow .2s ease, background .2s ease, border-color .2s ease;
            position: relative;
            overflow: hidden;
        }

            .btn.ghost {
                background: rgba(255,255,255,.02);
                border-style: solid
            }

            .btn.primary {
                background: linear-gradient(135deg,var(--gold),#b8860b);
                color: #000;
                border-color: rgba(255,255,255,.08)
            }

            .btn:hover {
                transform: translateY(-1px)
            }

            .btn.shine::after {
                content: "";
                position: absolute;
                inset: 0;
                translate: -120% 0;
                pointer-events: none;
                background: linear-gradient(120deg,transparent 0%,rgba(255,255,255,.35) 50%,transparent 100%);
                mix-blend-mode: screen;
                transition: translate .6s ease;
            }

            .btn.shine:hover::after {
                translate: 120% 0
            }

        /* LAYOUT */
        .layout {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 16px;
            display: grid;
            gap: 18px;
            grid-template-columns: 340px 1fr;
        }

        @media (max-width:980px) {
            .layout {
                grid-template-columns: 1fr
            }
        }

        /* CARD glassy */
        .card {
            position: relative;
            background: linear-gradient(180deg,rgba(22,26,38,.75),rgba(14,17,27,.75));
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,.08);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

            .card::before {
                content: "";
                position: absolute;
                inset: -1px;
                border-radius: inherit;
                pointer-events: none;
                background: radial-gradient(120% 60% at 0% 0%, rgba(142,240,207,.18), transparent 50%), radial-gradient(100% 60% at 100% 0%, rgba(80,200,255,.10), transparent 50%);
                mask: linear-gradient(#000,transparent 60%);
                opacity: .6;
            }

        .card-h {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(255,255,255,.06);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px
        }

        .card-c {
            padding: 16px
        }

        /* CONTROLS */
        .controls .row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px
        }

        .controls label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--muted)
        }

        .controls input, .controls select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.08);
            background: linear-gradient(180deg,#161b28,#121623);
            color: var(--text);
            box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
        }

        .legend {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 8px
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(255,255,255,.03);
            color: var(--muted);
            border: 1px solid rgba(255,255,255,.06)
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%
        }

            .dot.free {
                background: var(--accent)
            }

            .dot.busy {
                background: var(--danger)
            }

        /* STAGE */
        .stage {
            position: relative;
            border-radius: 18px;
            overflow: hidden;
            min-height: 600px;
            background: #0c0f17;
            border: 1px solid rgba(255,255,255,.06)
        }

            .stage .backdrop {
                width: 100%;
                height: 100%;
                object-fit: contain;
                object-position: center;
                display: block;
                user-select: none;
                pointer-events: none;
                background: #0b0e15
            }

        .tables {
            position: absolute;
            inset: 0
        }

        .marker {
            --size: 38px;
            position: absolute;
            width: var(--size);
            height: var(--size);
            transform: translate(-50%,-50%);
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-weight: 800;
            font-size: 14px;
            color: #041014;
            cursor: pointer;
            user-select: none;
            border: 2px solid rgba(255,255,255,.25);
            transition: transform .12s ease, filter .12s ease, opacity .2s ease, box-shadow .2s ease;
            background: radial-gradient(120% 120% at 30% 30%, #eafff7 0%, #b8ffe7 30%, #8ef0cf 70%);
            box-shadow: 0 0 0 0 var(--ring);
        }

            .marker.free {
                animation: ping 2.2s ease-out infinite
            }

        @keyframes ping {
            0% {
                box-shadow: 0 0 0 0 var(--ring)
            }

            70% {
                box-shadow: 0 0 0 14px rgba(142,240,207,0)
            }

            100% {
                box-shadow: 0 0 0 0 rgba(142,240,207,0)
            }
        }

        .marker.busy {
            background: radial-gradient(120% 120% at 30% 30%, #ffd1d1 0%, #ff9a9a 40%, #ff6b6b 75%);
            color: #0b0f14;
            box-shadow: 0 0 18px rgba(255,107,107,.28)
        }

        .marker:hover {
            transform: translate(-50%,-50%) scale(1.14);
            z-index: 10
        }

        /* TIME PICKER */
        .timepicker {
            position: relative
        }

            .timepicker .inputlike {
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
                padding: 10px 12px;
                border-radius: 12px;
                border: 1px solid rgba(255,255,255,.08);
                background: linear-gradient(180deg,#161b28,#121623);
                color: var(--text);
                cursor: pointer
            }

            .timepicker .caret {
                width: 0;
                height: 0;
                border-left: 6px solid transparent;
                border-right: 6px solid transparent;
                border-top: 6px solid rgba(255,255,255,.6)
            }

        .timepanel {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 220px;
            max-height: 320px;
            display: none;
            background: var(--panel);
            border: 1px solid rgba(255,255,255,.12);
            border-radius: 14px;
            box-shadow: var(--shadow);
            padding: 8px
        }

            .timepanel.open {
                display: block
            }

            .timepanel .grid {
                display: grid;
                gap: 6px;
                grid-template-columns: repeat(2,1fr);
                max-height: 260px;
                overflow: auto;
                padding: 4px
            }

            .timepanel .header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 6px 8px 8px;
                gap: 8px
            }

            .timepanel .search {
                width: 100%;
                padding: 10px 12px;
                border-radius: 10px;
                border: 1px solid rgba(255,255,255,.10);
                background: var(--panel-2);
                color: var(--text)
            }

        .timeopt {
            border: none;
            border-radius: 10px;
            padding: 10px 0;
            text-align: center;
            cursor: pointer;
            background: var(--panel-2);
            color: var(--text);
            font-weight: 600;
            transition: background .15s ease, transform .06s ease
        }

            .timeopt:hover {
                background: #20283a;
                transform: translateY(-1px)
            }

            .timeopt[aria-selected="true"] {
                outline: 2px solid color-mix(in srgb, var(--accent-2) 70%, #fff)
            }

        /* TOAST + DIALOG */
        .toast {
            position: fixed;
            right: 16px;
            bottom: 16px;
            background: var(--panel-2);
            color: var(--text);
            border: 1px solid rgba(255,255,255,.08);
            padding: 12px 14px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            z-index: 100;
            display: none
        }

        dialog {
            border: none;
            border-radius: 16px;
            padding: 0;
            background: var(--panel);
            color: var(--text);
            width: min(560px,92vw)
        }

            dialog::backdrop {
                background: rgba(0,0,0,.6)
            }

        .modal-h {
            padding: 16px 18px;
            border-bottom: 1px solid rgba(255,255,255,.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(212,175,55,.12), rgba(184,134,11,.08))
        }

        .modal-c {
            padding: 16px 18px
        }

        .modal-f {
            padding: 16px 18px;
            border-top: 1px solid rgba(255,255,255,.06);
            display: flex;
            gap: 10px;
            justify-content: flex-end
        }

        .xbtn {
            background: transparent;
            border: none;
            color: var(--muted);
            font-size: 20px;
            cursor: pointer
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px
        }

        @media (max-width:560px) {
            .grid {
                grid-template-columns: 1fr
            }
        }

        .modal-c label {
            font-weight: 600;
            color: var(--muted);
            display: block;
            margin-bottom: 6px
        }

        .modal-c input, .modal-c textarea, .modal-c select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.08);
            background: var(--panel-2);
            color: var(--text)
        }

        .subtext {
            color: var(--muted);
            font-size: 12px
        }
    </style>
</head>
<body>
    <header class="hero">
        <h1 class="hero-title">Vanilla Unicorn · Rezervări</h1>
        <div class="toolbar">
            <a class="btn ghost shine" href="./index.html">Acasă</a>
            <a class="btn ghost shine" href="./service.html">Service Auto</a>
        </div>
    </header>

    <main class="layout">
        <!-- CONTROALE -->
        <section class="card controls" aria-label="Filtre și acțiuni">
            <div class="card-h">
                <strong>Selectează intervalul</strong>
                <small id="availabilityMeta" class="subtext" aria-live="polite"></small>
            </div>
            <div class="card-c">
                <div class="row">
                    <div style="flex:1">
                        <label for="date">Data</label>
                        <input id="date" type="date" />
                    </div>

                    <div style="width:170px">
                        <label for="time">Ora</label>
                        <div class="timepicker" id="timepicker">
                            <button type="button" class="inputlike" id="timeBtn" aria-haspopup="listbox" aria-expanded="false">
                                <span id="timeLabel">--:--</span>
                                <span class="caret" aria-hidden="true"></span>
                            </button>
                            <div class="timepanel" id="timePanel">
                                <div class="header">
                                    <input class="search" id="timeSearch" placeholder="Caută (ex. 21:30)" aria-label="Caută ora" />
                                    <span class="kbd">Esc</span>
                                </div>
                                <div class="grid" id="timeGrid" role="listbox" aria-label="Alege ora"></div>
                            </div>
                            <input id="time" type="hidden" />
                        </div>
                    </div>

                    <div style="width:150px">
                        <label for="duration">Durata</label>
                        <select id="duration">
                            <option value="60">60 min</option>
                            <option value="90">90 min</option>
                            <option value="120" selected>120 min</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <button id="check" class="btn primary shine">Verifică disponibilitatea</button>
                </div>
                <div class="legend">
                    <span class="pill"><span class="dot free"></span> Liber</span>
                    <span class="pill"><span class="dot busy"></span> Rezervat</span>
                    <span class="subtext">* Click pe o masă liberă pentru rezervare</span>
                </div>
            </div>
        </section>

        <!-- PLAN SALĂ -->
        <section class="card">
            <div class="card-h">
                <strong>Plan Vanilla Unicorn</strong>
                <small class="subtext">Club Layout cu 11 mese</small>
            </div>
            <div id="stage" class="card-c stage">
                <img id="backdrop" class="backdrop" alt="Plan Vanilla Unicorn" />
                <div class="tables" id="tables" aria-live="polite"></div>
            </div>
        </section>
    </main>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <!-- MODAL -->
    <dialog id="modal">
        <form method="dialog" id="reservationForm">
            <div class="modal-h">
                <strong>Rezervare masă <span id="mTable"></span></strong>
                <button type="button" class="xbtn" id="closeModal" aria-label="Închide">×</button>
            </div>
            <div class="modal-c">
                <div style="margin-bottom:10px" class="subtext">Interval: <span id="mWhen"></span></div>
                <div class="grid">
                    <div><label for="mName">Nume</label><input id="mName" required placeholder="Nume și prenume" /></div>
                    <div><label for="mPhone">Telefon</label><input id="mPhone" placeholder="07xx xxx xxx" /></div>
                    <div><label for="mParty">Numărul persoanelor</label><input id="mParty" type="number" min="1" max="20" value="2" /></div>
                    <div>
                        <label for="mDuration">Durata</label>
                        <select id="mDuration"><option value="60">60 min</option><option value="90">90 min</option><option value="120" selected>120 min</option></select>
                    </div>
                    <div style="grid-column:1/-1"><label for="mNote">Notă specială</label><textarea id="mNote" rows="3" placeholder="Preferințe / ocazie specială / cerințe VIP"></textarea></div>
                </div>
            </div>
            <div class="modal-f">
                <button type="button" class="btn ghost shine" id="cancelBtn">Anulează</button>
                <button id="saveBtn" class="btn primary shine" value="default">Confirmă rezervarea</button>
            </div>
        </form>
    </dialog>

    <script>
        /* ========== BACKDROP + LAYOUT STATIC ========== */
        const BACKGROUND_SRC = './plan4.png';
        const LAYOUT_STATIC = Object.freeze([
            { id: 1, left: 48.0, top: 27.3 }, { id: 2, left: 50.5, top: 40.0 }, { id: 3, left: 58.5, top: 34.0 },
            { id: 4, left: 62.5, top: 45.0 }, { id: 5, left: 70.0, top: 45.0 }, { id: 6, left: 47.0, top: 54.0 },
            { id: 7, left: 62.5, top: 55.0 }, { id: 8, left: 70.0, top: 55.0 }, { id: 9, left: 48.0, top: 73.0 },
            { id: 10, left: 57.2, top: 73.0 }, { id: 11, left: 27.5, top: 80.0 }
        ]);
        const layout = LAYOUT_STATIC;
        const API_BASE = window.location.origin;

        const backdrop = document.getElementById('backdrop');
        if (backdrop) backdrop.src = BACKGROUND_SRC;

        /* ========== TIME PICKER ========== */
        const timeBtn = document.getElementById('timeBtn');
        const timeLabel = document.getElementById('timeLabel');
        const timeInput = document.getElementById('time');
        const timePanel = document.getElementById('timePanel');
        const timeGrid = document.getElementById('timeGrid');
        const timeSearch = document.getElementById('timeSearch');
        document.body.appendChild(timePanel);

        const timeOptions = (() => {
            const opts = []; let d = new Date(); d.setHours(12, 0, 0, 0);
            const end = new Date(d); end.setHours(28, 0, 0, 0);
            while (d <= end) { opts.push(d.toTimeString().slice(0, 5)); d = new Date(d.getTime() + 30 * 60000) }
            return opts;
        })();

        function renderTimeOptions(filter = "") {
            const f = filter.trim().toLowerCase(); timeGrid.innerHTML = "";
            const list = timeOptions.filter(t => t.includes(f));
            for (const t of list) {
                const b = document.createElement('button');
                b.type = 'button'; b.className = 'timeopt'; b.textContent = t; b.role = 'option';
                b.setAttribute('aria-selected', t === timeInput.value ? 'true' : 'false');
                b.addEventListener('click', () => selectTime(t, true));
                b.addEventListener('mouseenter', () => b.focus({ preventScroll: true }));
                timeGrid.appendChild(b);
            }
            setTimeout(() => timeGrid.querySelector('.timeopt[aria-selected="true"]')?.scrollIntoView({ block: 'nearest' }), 0);
        }
        function placePanel() {
            const r = timeBtn.getBoundingClientRect(), m = 6, w = Math.max(220, r.width);
            timePanel.style.width = w + 'px';
            timePanel.style.left = Math.min(r.left, window.innerWidth - w - 8) + 'px';
            timePanel.style.top = (r.bottom + m) + 'px';
            timePanel.classList.add('open');
            const pr = timePanel.getBoundingClientRect();
            if (pr.bottom > window.innerHeight) timePanel.style.top = (r.top - pr.height - m) + 'px';
        }
        function openTimePanel() { renderTimeOptions(); placePanel(); timeBtn.setAttribute('aria-expanded', 'true'); timeSearch.value = ""; setTimeout(() => timeSearch.focus(), 10); window.addEventListener('scroll', closeTimePanel, { once: true }); window.addEventListener('resize', closeTimePanel, { once: true }); document.addEventListener('mousedown', onClickOutside); document.addEventListener('keydown', onTimeKey); }
        function closeTimePanel() { timePanel.classList.remove('open'); timeBtn.setAttribute('aria-expanded', 'false'); document.removeEventListener('mousedown', onClickOutside); document.removeEventListener('keydown', onTimeKey); }
        function onClickOutside(e) { if (!timePanel.contains(e.target) && e.target !== timeBtn) closeTimePanel(); }
        function onTimeKey(e) {
            if (e.key === 'Escape') { closeTimePanel(); timeBtn.focus(); }
            if (e.key === 'ArrowDown' || e.key === 'ArrowUp') { e.preventDefault(); const a = [...timeGrid.querySelectorAll('.timeopt')]; if (!a.length) return; const i = a.findIndex(x => x === document.activeElement); const n = e.key === 'ArrowDown' ? Math.min(i + 1, a.length - 1) : Math.max(i - 1, 0); (a[n] || a[0]).focus(); }
            if (e.key === 'Enter' && document.activeElement?.classList.contains('timeopt')) document.activeElement.click();
        }
        function selectTime(t, announce) { timeInput.value = t; timeLabel.textContent = t; closeTimePanel(); if (announce) refreshStatus(); }
        timeBtn.addEventListener('click', () => timePanel.classList.contains('open') ? closeTimePanel() : openTimePanel());
        timeSearch.addEventListener('input', e => renderTimeOptions(e.target.value));

        /* ========== ELEMENTS & DEFAULTS ========== */
        const elDate = document.getElementById('date');
        const elDur = document.getElementById('duration');
        const btnCheck = document.getElementById('check');
        const tablesEl = document.getElementById('tables');
        const toast = document.getElementById('toast');
        const availabilityMeta = document.getElementById('availabilityMeta');

        const now = new Date(); now.setMinutes(now.getMinutes() < 30 ? 30 : 60, 0, 0);
        elDate.value = toInputDate(now);
        const startDefault = (() => { const hhmm = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`; return timeOptions.includes(hhmm) ? hhmm : timeOptions[0]; })();
        selectTime(startDefault, false);

        btnCheck.addEventListener('click', refreshStatus);
        elDate.addEventListener('change', refreshStatus);

        function buildMarkers() {
            tablesEl.innerHTML = '';
            for (const pos of layout) {
                const m = document.createElement('button');
                m.className = 'marker'; m.dataset.id = String(pos.id);
                m.style.left = pos.left + '%'; m.style.top = pos.top + '%';
                m.setAttribute('aria-label', `Masa ${pos.id}`); m.setAttribute('tabindex', '0');
                m.textContent = String(pos.id);
                m.addEventListener('click', () => onMarkerClick(pos.id));
                m.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); m.click(); } });
                tablesEl.appendChild(m);
            }
        }
        buildMarkers();

        /* ========== STATUS & RESERVARE ========== */
        async function refreshStatus() {
            const { iso, human } = currentSlotIso();
            btnCheck.setAttribute('aria-busy', 'true');
            showToast('Se încarcă disponibilitatea…');
            try {
                const r = await fetch(`${API_BASE}/status?startAt=${encodeURIComponent(iso)}`);
                if (!r.ok) throw new Error('Eroare la citirea statusului.');
                const data = await r.json();
                const map = new Map(data.map(x => [x.tableId, x.isReserved]));
                let freeCount = 0;
                for (const el of tablesEl.querySelectorAll('.marker')) {
                    const id = Number(el.dataset.id);
                    const busy = map.get(id) === true;
                    el.classList.toggle('busy', busy);
                    el.classList.toggle('free', !busy);
                    if (!busy) freeCount++;
                    el.title = `Masa ${id} · ${busy ? 'Rezervată' : 'Liberă'} — ${human}`;
                }
                availabilityMeta.textContent = `${freeCount} ${freeCount === 1 ? 'masă liberă' : 'mese libere'} la ${human}`;
                showToast('Disponibilitatea a fost actualizată.');
            } catch (err) { console.error(err); showToast('Nu am putut încărca statusul (verifică API și CORS).'); }
            finally { btnCheck.removeAttribute('aria-busy'); }
        }

        function currentSlotIso() {
            const d = elDate.value; const t = timeInput.value || '20:00';
            const local = new Date(`${d}T${t}:00`); const iso = local.toISOString();
            const human = local.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
            return { iso, human, local };
        }

        // MODAL
        const modal = document.getElementById('modal');
        const mTable = document.getElementById('mTable');
        const mWhen = document.getElementById('mWhen');
        const mName = document.getElementById('mName');
        const mPhone = document.getElementById('mPhone');
        const mParty = document.getElementById('mParty');
        const mDuration = document.getElementById('mDuration');
        const mNote = document.getElementById('mNote');
        const closeModal = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveBtn = document.getElementById('saveBtn');

        function onMarkerClick(id) {
            const el = tablesEl.querySelector(`.marker[data-id="${id}"]`);
            if (el.classList.contains('busy')) return;
            const { iso, human } = currentSlotIso();
            mTable.textContent = id; mWhen.textContent = human;
            mDuration.value = Number(document.getElementById('duration').value);
            mName.value = ''; mPhone.value = ''; mParty.value = '2'; mNote.value = '';
            modal.showModal();

            function cleanup() { closeModal.removeEventListener('click', onClose); cancelBtn.removeEventListener('click', onClose); saveBtn.removeEventListener('click', onSave); }
            function onClose() { modal.close(); cleanup(); }
            async function onSave(ev) {
                ev.preventDefault(); saveBtn.setAttribute('aria-busy', 'true');
                try {
                    const payload = {
                        tableId: Number(id), startAt: new Date(iso).toISOString(),
                        durationMinutes: Number(mDuration.value || '60'),
                        customerName: mName.value.trim(), phone: mPhone.value.trim() || null,
                        partySize: mParty.value ? Number(mParty.value) : null, note: mNote.value.trim() || null
                    };
                    const r = await fetch(`${API_BASE}/reservations`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (r.status === 201) { showToast('Rezervare creată cu succes!'); modal.close(); refreshStatus(); }
                    else if (r.status === 409) { showToast('Ups, masa tocmai a fost rezervată. Încearcă altă masă sau oră.'); }
                    else { const txt = await r.text(); showToast('Eroare la salvare: ' + (txt || r.status)); }
                } catch (err) { console.error(err); showToast('Eroare rețea către API.'); }
                finally { saveBtn.removeAttribute('aria-busy'); cleanup(); }
            }
            closeModal.addEventListener('click', onClose);
            cancelBtn.addEventListener('click', onClose);
            saveBtn.addEventListener('click', onSave);
        }

        /* ========== UTILS ========== */
        function toInputDate(d) { return d.toISOString().slice(0, 10) }
        function showToast(msg) { toast.textContent = msg; toast.style.display = 'block'; clearTimeout(showToast.t); showToast.t = setTimeout(() => toast.style.display = 'none', 2500); }

        // kickoff
        refreshStatus();
    </script>
</body>
</html>
