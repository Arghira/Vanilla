<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vanilla Unicorn – Rezervări</title>
    <style>
        :root {
            --bg: #0f1115;
            --panel: #171a21;
            --panel-2: #1d2230;
            --text: #e6eaf2;
            --muted: #9aa4b2;
            --accent: #8ef0cf;
            --accent-2: #50c8ff;
            --danger: #ff6b6b;
            --warning: #ffd166;
            --shadow: 0 10px 30px rgba(0,0,0,.35);
            --gold: #d4af37;
        }

        * {
            box-sizing: border-box
        }

        html, body {
            height: 100%
        }

        body {
            margin: 0;
            background: radial-gradient(80% 80% at 50% 0%, #151822, #0e1016);
            color: var(--text);
            font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 18px 22px;
            background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
            border-bottom: 1px solid rgba(255,255,255,.06);
            position: sticky;
            top: 0;
            z-index: 30;
            backdrop-filter: blur(6px);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px
        }

            .brand .logo {
                width: 48px;
                height: 48px;
                border-radius: 12px;
                background: linear-gradient(135deg, var(--gold), #b8860b);
                box-shadow: 0 0 0 2px #12141a inset;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                font-weight: bold;
                color: #000;
            }

            .brand h1 {
                margin: 0;
                font-size: 18px;
                letter-spacing: .3px;
                background: linear-gradient(135deg, var(--gold), #fff);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

        .layout {
            max-width: 1400px;
            margin: 22px auto;
            padding: 0 16px;
            display: grid;
            gap: 16px;
            grid-template-columns: 320px 1fr
        }

        @media (max-width: 980px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--panel);
            border: 1px solid rgba(255,255,255,.06);
            border-radius: 16px;
            box-shadow: var(--shadow)
        }

            .card .card-h {
                padding: 14px 16px;
                border-bottom: 1px solid rgba(255,255,255,.06);
                display: flex;
                align-items: center;
                justify-content: space-between
            }

            .card .card-c {
                padding: 16px
            }

        .controls .row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px
        }

        .controls label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--muted)
        }

        .controls input, .controls select, .controls button {
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.08);
            background: var(--panel-2);
            color: var(--text)
        }

        .controls button {
            cursor: pointer;
            transition: transform .05s ease;
            font-weight: 600
        }

        .controls .primary {
            background: linear-gradient(135deg, var(--gold), #b8860b);
            border-color: rgba(255,255,255,.08);
            color: #000;
        }

            .controls .primary:hover {
                transform: translateY(-1px)
            }

        .legend {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 8px
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: var(--panel-2);
            color: var(--muted);
            border: 1px solid rgba(255,255,255,.06)
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%
        }

            .dot.free {
                background: var(--accent)
            }

            .dot.busy {
                background: var(--danger)
            }

        .stage {
            position: relative;
            border-radius: 18px;
            overflow: hidden;
            min-height: 600px;
            background: #0e1117;
            border: 1px solid rgba(255,255,255,.06)
        }

            .stage .backdrop {
                width: 100%;
                height: 100%;
                object-fit: contain;
                display: block;
                opacity: 1;
                user-select: none;
                pointer-events: none;
                background: #1a1a1a;
            }

        .tables {
            position: absolute;
            inset: 0
        }

        .marker {
            --size: 38px;
            position: absolute;
            width: var(--size);
            height: var(--size);
            transform: translate(-50%, -50%);
            border-radius: 50%;
            display: grid;
            place-items: center;
            font-weight: 700;
            font-size: 14px;
            color: #0f131a;
            cursor: pointer;
            user-select: none;
            filter: drop-shadow(0 3px 8px rgba(0,0,0,.7));
            transition: transform .12s ease, box-shadow .12s ease, opacity .2s ease;
            border: 2px solid rgba(255,255,255,0.3);
        }

            .marker.free {
                background: var(--accent);
                box-shadow: 0 0 15px rgba(142, 240, 207, 0.4);
            }

            .marker.busy {
                background: var(--danger);
                color: #0b0f14;
                box-shadow: 0 0 15px rgba(255, 107, 107, 0.4);
            }

            .marker:hover {
                transform: translate(-50%, -50%) scale(1.15);
                z-index: 10;
            }

            .marker[data-edit="true"] {
                outline: 2px dashed rgba(255,255,255,.5);
                outline-offset: 4px;
            }

        .toast {
            position: fixed;
            right: 16px;
            bottom: 16px;
            background: var(--panel-2);
            color: var(--text);
            border: 1px solid rgba(255,255,255,.08);
            padding: 12px 14px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            z-index: 100;
            display: none
        }

        dialog {
            border: none;
            border-radius: 16px;
            padding: 0;
            background: var(--panel);
            color: var(--text);
            width: min(560px, 92vw)
        }

            dialog::backdrop {
                background: rgba(0,0,0,.6)
            }

        .modal-h {
            padding: 16px 18px;
            border-bottom: 1px solid rgba(255,255,255,.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(184, 134, 11, 0.1));
        }

        .modal-c {
            padding: 16px 18px
        }

        .modal-f {
            padding: 16px 18px;
            border-top: 1px solid rgba(255,255,255,.06);
            display: flex;
            gap: 10px;
            justify-content: flex-end
        }

        .xbtn {
            background: transparent;
            border: none;
            color: var(--muted);
            font-size: 20px;
            cursor: pointer
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px
        }

        @media(max-width:560px) {
            .grid {
                grid-template-columns: 1fr
            }
        }

        .modal-c label {
            font-weight: 600;
            color: var(--muted);
            display: block;
            margin-bottom: 6px
        }

        .modal-c input, .modal-c textarea, .modal-c select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,.08);
            background: var(--panel-2);
            color: var(--text)
        }

        .toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .ghost {
            background: transparent;
            border: 1px dashed rgba(255,255,255,.25)
        }

        .subtext {
            color: var(--muted);
            font-size: 12px
        }
    </style>
</head>
<body>
    <header>
        <div class="brand">
            <div class="logo">🦄</div>
            <h1>Vanilla Unicorn · Rezervări</h1>
        </div>
        <div class="toolbar">
            <button id="editToggle" class="ghost">Editare amplasare mese</button>
            <button id="exportLayout" class="ghost">Export layout</button>
        </div>
    </header>

    <main class="layout">
        <section class="card controls" aria-label="Filtre și acțiuni">
            <div class="card-h">
                <strong>Selectează intervalul</strong>
            </div>
            <div class="card-c">
                <div class="row">
                    <div style="flex:1">
                        <label for="date">Data</label>
                        <input id="date" type="date" />
                    </div>
                    <div style="width:130px">
                        <label for="time">Ora</label>
                        <input id="time" type="time" step="3600" />
                    </div>
                    <div style="width:150px">
                        <label for="duration">Durata</label>
                        <select id="duration">
                            <option value="60">60 min</option>
                            <option value="90">90 min</option>
                            <option value="120">120 min</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <button id="check" class="primary">Verifică disponibilitatea</button>
                </div>
                <div class="legend">
                    <span class="pill"><span class="dot free"></span> Liber</span>
                    <span class="pill"><span class="dot busy"></span> Rezervat</span>
                    <span class="subtext">* Click pe o masă liberă pentru rezervare</span>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-h">
                <strong>Plan Vanilla Unicorn</strong>
                <small class="subtext">Club Layout cu 11 mese disponibile pentru rezervări</small>
            </div>
            <div id="stage" class="card-c stage">
                <img id="backdrop" class="backdrop" alt="Plan Vanilla Unicorn" />
                <div class="tables" id="tables" aria-live="polite"></div>
            </div>
        </section>
    </main>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <!-- Modal Rezervare -->
    <dialog id="modal">
        <form method="dialog" id="reservationForm">
            <div class="modal-h">
                <strong>Rezervare masă <span id="mTable"></span></strong>
                <button type="button" class="xbtn" id="closeModal" aria-label="Închide">×</button>
            </div>
            <div class="modal-c">
                <div style="margin-bottom:10px" class="subtext">Interval: <span id="mWhen"></span></div>
                <div class="grid">
                    <div>
                        <label for="mName">Nume</label>
                        <input id="mName" required placeholder="Nume și prenume" />
                    </div>
                    <div>
                        <label for="mPhone">Telefon</label>
                        <input id="mPhone" placeholder="07xx xxx xxx" />
                    </div>
                    <div>
                        <label for="mParty">Numărul persoanelor</label>
                        <input id="mParty" type="number" min="1" max="20" value="2" />
                    </div>
                    <div>
                        <label for="mDuration">Durata</label>
                        <select id="mDuration">
                            <option value="60" selected>60 min</option>
                            <option value="90">90 min</option>
                            <option value="120">120 min</option>
                        </select>
                    </div>
                    <div style="grid-column:1/-1">
                        <label for="mNote">Notă specială</label>
                        <textarea id="mNote" rows="3" placeholder="Preferințe / ocazie specială / cerințe VIP"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-f">
                <button type="button" class="ghost" id="cancelBtn">Anulează</button>
                <button id="saveBtn" class="primary" value="default">Confirmă rezervarea</button>
            </div>
        </form>
    </dialog>

    <script>
        // ===================== CONFIG =====================
        const API_BASE = window.location.origin;

        // Exact positions matching your Vanilla Unicorn floor plan image
        let layout = JSON.parse(localStorage.getItem('vanillaUnicornLayout') || 'null') || [
            { id: 1, left: 58.5, top: 23 },   // Upper right circular area
            { id: 2, left: 44, top: 34 },     // Left side middle
            { id: 3, left: 69, top: 28 },     // Right side upper
            { id: 4, left: 65, top: 39 },     // Right side middle
            { id: 5, left: 83, top: 39 },     // Far right middle
            { id: 6, left: 35, top: 48 },     // Left corridor
            { id: 7, left: 65, top: 48 },     // Right corridor
            { id: 8, left: 83, top: 48 },     // Far right lower
            { id: 9, left: 45, top: 66 },     // Lower left booth
            { id: 10, left: 67, top: 66 },    // Lower right booth
            { id: 11, left: 20, top: 69 }     // Far left private area
        ];

        const TABLES = layout.map(p => p.id);

        // Create a proper Vanilla Unicorn floor plan matching your image
        const backdrop = document.getElementById('backdrop');

        function createVanillaUnicornPlan() {
            const canvas = document.createElement('canvas');
            canvas.width = 1000;
            canvas.height = 650;
            const ctx = canvas.getContext('2d');

            // Base background - dark gray
            ctx.fillStyle = '#2d2d2d';
            ctx.fillRect(0, 0, 1000, 650);

            // Main building outline
            ctx.fillStyle = '#3a3a3a';
            ctx.beginPath();
            // Complex building shape matching your image
            ctx.moveTo(50, 150);
            ctx.lineTo(400, 150);
            ctx.lineTo(400, 50);
            ctx.lineTo(600, 50);
            ctx.lineTo(600, 150);
            ctx.lineTo(850, 150);
            ctx.lineTo(850, 300);
            ctx.lineTo(950, 300);
            ctx.lineTo(950, 550);
            ctx.lineTo(750, 550);
            ctx.lineTo(750, 500);
            ctx.lineTo(250, 500);
            ctx.lineTo(250, 600);
            ctx.lineTo(50, 600);
            ctx.closePath();
            ctx.fill();

            // Interior walls
            ctx.strokeStyle = '#1a1a1a';
            ctx.lineWidth = 3;

            // Main interior divisions
            ctx.beginPath();
            // Vertical divisions
            ctx.moveTo(400, 150);
            ctx.lineTo(400, 350);
            ctx.moveTo(600, 150);
            ctx.lineTo(600, 350);
            // Horizontal divisions
            ctx.moveTo(250, 350);
            ctx.lineTo(750, 350);
            ctx.moveTo(250, 450);
            ctx.lineTo(650, 450);
            ctx.stroke();

            // Stage area (upper center)
            ctx.fillStyle = '#4a4a5a';
            ctx.fillRect(450, 80, 100, 60);
            ctx.strokeStyle = '#6a6a7a';
            ctx.strokeRect(450, 80, 100, 60);

            // Bar area (right side)
            ctx.fillStyle = '#5a4a4a';
            ctx.fillRect(780, 200, 60, 100);
            ctx.strokeStyle = '#7a6a6a';
            ctx.strokeRect(780, 200, 60, 100);

            // VIP booths (bottom area)
            ctx.fillStyle = '#4a5a4a';
            for (let i = 0; i < 3; i++) {
                ctx.fillRect(300 + i * 120, 470, 80, 80);
                ctx.strokeStyle = '#6a7a6a';
                ctx.strokeRect(300 + i * 120, 470, 80, 80);
            }

            // Add some decorative elements
            ctx.fillStyle = '#555';
            // Small decorative circles
            for (let i = 0; i < 8; i++) {
                ctx.beginPath();
                ctx.arc(200 + i * 80, 250, 8, 0, Math.PI * 2);
                ctx.fill();
            }

            // Pillars
            ctx.fillStyle = '#444';
            ctx.fillRect(300, 200, 15, 15);
            ctx.fillRect(500, 200, 15, 15);
            ctx.fillRect(700, 200, 15, 15);

            return canvas.toDataURL();
        }

        backdrop.src = createVanillaUnicornPlan();

        // ===================== UI INITIAL =====================
        const elDate = document.getElementById('date');
        const elTime = document.getElementById('time');
        const elDur = document.getElementById('duration');
        const btnCheck = document.getElementById('check');
        const tablesEl = document.getElementById('tables');
        const toast = document.getElementById('toast');

        // Set default date/time
        const now = new Date();
        now.setMinutes(0, 0, 0);
        now.setHours(now.getHours() + 1);
        elDate.value = toInputDate(now);
        elTime.value = toInputTime(now);

        btnCheck.addEventListener('click', refreshStatus);
        elDate.addEventListener('change', refreshStatus);
        elTime.addEventListener('change', refreshStatus);

        function buildMarkers() {
            tablesEl.innerHTML = '';
            for (const pos of layout) {
                const m = document.createElement('button');
                m.className = 'marker';
                m.dataset.id = String(pos.id);
                m.style.left = pos.left + '%';
                m.style.top = pos.top + '%';
                m.ariaLabel = `Masa ${pos.id}`;
                m.textContent = String(pos.id);
                m.addEventListener('click', () => onMarkerClick(pos.id));
                tablesEl.appendChild(m);
            }
        }

        buildMarkers();

        // ===================== STATUS & REZERVARE =====================
        async function refreshStatus() {
            const { iso, human } = currentSlotIso();
            showToast('Se încarcă disponibilitatea…');
            try {
                const r = await fetch(`${API_BASE}/status?startAt=${encodeURIComponent(iso)}`);
                if (!r.ok) throw new Error('Eroare la citirea statusului.');
                const data = await r.json();
                const map = new Map(data.map(x => [x.tableId, x.isReserved]));
                for (const el of tablesEl.querySelectorAll('.marker')) {
                    const id = Number(el.dataset.id);
                    const busy = map.get(id) === true;
                    el.classList.toggle('busy', busy);
                    el.classList.toggle('free', !busy);
                    el.title = `Masa ${id} · ${busy ? 'Rezervată' : 'Liberă'} — ${human}`;
                }
                showToast('Disponibilitatea a fost actualizată.');
            } catch (err) {
                console.error(err);
                showToast('Nu am putut încărca statusul (verifică API_BASE și CORS).');
            }
        }

        function currentSlotIso() {
            const d = elDate.value; const t = elTime.value || '20:00';
            const local = new Date(`${d}T${t}:00`);
            const iso = local.toISOString();
            const human = local.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
            return { iso, human, local };
        }

        // MODAL REZERVARE
        const modal = document.getElementById('modal');
        const mTable = document.getElementById('mTable');
        const mWhen = document.getElementById('mWhen');
        const mName = document.getElementById('mName');
        const mPhone = document.getElementById('mPhone');
        const mParty = document.getElementById('mParty');
        const mDuration = document.getElementById('mDuration');
        const mNote = document.getElementById('mNote');
        const closeModal = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const saveBtn = document.getElementById('saveBtn');

        function onMarkerClick(id) {
            const el = tablesEl.querySelector(`.marker[data-id="${id}"]`);
            if (el.classList.contains('busy')) { return; }
            const { iso, human } = currentSlotIso();
            mTable.textContent = id;
            mWhen.textContent = human;
            mDuration.value = elDur.value;
            mName.value = '';
            mPhone.value = '';
            mParty.value = '2';
            mNote.value = '';
            modal.showModal();

            function cleanup() {
                closeModal.removeEventListener('click', onClose);
                cancelBtn.removeEventListener('click', onClose);
                saveBtn.removeEventListener('click', onSave);
            }
            function onClose() { modal.close(); cleanup(); }
            async function onSave(ev) {
                ev.preventDefault(); saveBtn.disabled = true; saveBtn.textContent = 'Se salvează…';
                try {
                    const payload = {
                        tableId: Number(id),
                        startAt: new Date(iso).toISOString(),
                        durationMinutes: Number(mDuration.value || '60'),
                        customerName: mName.value.trim(),
                        phone: mPhone.value.trim() || null,
                        partySize: mParty.value ? Number(mParty.value) : null,
                        note: mNote.value.trim() || null
                    };
                    const r = await fetch(`${API_BASE}/reservations`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (r.status === 201) {
                        showToast('Rezervare creată cu succes!');
                        modal.close(); refreshStatus();
                    } else if (r.status === 409) {
                        showToast('Ups, masa tocmai a fost rezervată. Încearcă altă masă sau oră.');
                    } else {
                        const txt = await r.text();
                        showToast('Eroare la salvare: ' + (txt || r.status));
                    }
                } catch (err) {
                    console.error(err); showToast('Eroare rețea către API.');
                } finally { saveBtn.disabled = false; saveBtn.textContent = 'Confirmă rezervarea'; cleanup(); }
            }

            closeModal.addEventListener('click', onClose);
            cancelBtn.addEventListener('click', onClose);
            saveBtn.addEventListener('click', onSave);
        }

        // ===================== EDIT MODE =====================
        const editToggle = document.getElementById('editToggle');
        const exportLayout = document.getElementById('exportLayout');
        let editMode = false; let dragEl = null;

        editToggle.addEventListener('click', () => {
            editMode = !editMode;
            editToggle.classList.toggle('primary', editMode);
            for (const el of tablesEl.querySelectorAll('.marker')) {
                el.dataset.edit = String(editMode);
                el.style.cursor = editMode ? 'move' : 'pointer';
            }
        });

        exportLayout.addEventListener('click', () => {
            const data = layout.map(p => ({ id: p.id, left: roundPct(getPctLeft(p.id)), top: roundPct(getPctTop(p.id)) }));
            navigator.clipboard.writeText(JSON.stringify(data, null, 2));
            localStorage.setItem('vanillaUnicornLayout', JSON.stringify(data));
            showToast('Layout copiat în clipboard și salvat.');
        });

        function roundPct(v) { return Math.max(0, Math.min(100, Math.round(v * 10) / 10)); }
        function getPctLeft(id) { const el = tablesEl.querySelector(`.marker[data-id="${id}"]`); return (el.offsetLeft + el.offsetWidth / 2) / tablesEl.clientWidth * 100; }
        function getPctTop(id) { const el = tablesEl.querySelector(`.marker[data-id="${id}"]`); return (el.offsetTop + el.offsetHeight / 2) / tablesEl.clientHeight * 100; }

        tablesEl.addEventListener('pointerdown', (e) => {
            if (!editMode) return; const t = e.target; if (!(t instanceof HTMLElement) || !t.classList.contains('marker')) return;
            dragEl = t; dragEl.setPointerCapture(e.pointerId);
        });

        tablesEl.addEventListener('pointermove', (e) => {
            if (!editMode || !dragEl) return;
            const rect = tablesEl.getBoundingClientRect();
            const x = (e.clientX - rect.left) / rect.width * 100;
            const y = (e.clientY - rect.top) / rect.height * 100;
            dragEl.style.left = Math.max(0, Math.min(100, x)) + '%';
            dragEl.style.top = Math.max(0, Math.min(100, y)) + '%';
        });

        const endDrag = () => { if (dragEl) { dragEl.releasePointerCapture; dragEl = null; } };
        tablesEl.addEventListener('pointerup', endDrag);
        tablesEl.addEventListener('pointercancel', endDrag);

        // Drag&drop imagine
        const stage = document.getElementById('stage');
        stage.addEventListener('dragover', e => { e.preventDefault(); });
        stage.addEventListener('drop', e => {
            e.preventDefault();
            const f = e.dataTransfer?.files?.[0];
            if (!f) return;
            const reader = new FileReader();
            reader.onload = ev => { backdrop.src = ev.target.result; };
            reader.readAsDataURL(f);
        });

        // ===================== UTILS =====================
        function toInputDate(d) { return d.toISOString().slice(0, 10); }
        function toInputTime(d) { return String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0'); }
        function showToast(msg) { toast.textContent = msg; toast.style.display = 'block'; clearTimeout(showToast.t); showToast.t = setTimeout(() => toast.style.display = 'none', 2500); }

        // Initial status load
        refreshStatus();
    </script>
</body>
</html>